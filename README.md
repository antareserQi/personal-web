# 账单合并工具 (Bill Merger Tool)

一个用于合并微信和支付宝账单的Python工具，支持按月份导出或合并导出，并提供丰富的数据处理和格式化功能。

## 项目介绍

本工具旨在解决用户需要手动整理多个支付平台账单的痛点，通过自动化方式将微信和支付宝的账单数据进行合并、清洗、标准化和格式化，生成统一的Excel格式账单。工具支持多平台账单数据的智能识别、字段映射、数据验证和专业Excel格式化，帮助用户高效管理个人财务数据。

## 功能特性

- **多平台支持**：支持微信和支付宝账单的导入和合并，实现多平台数据的统一管理
- **智能分类**：按月份自动分类和导出账单，便于用户按时间段查看和分析
- **数据标准化**：统一不同平台的交易状态、字段格式，确保数据一致性
- **专业格式**：应用Excel专业格式，包括首行冻结、筛选功能、标准日期格式和会计专用格式
- **收支计算**：自动计算收支金额，支出为负值，收入为正值，便于财务分析
- **数据验证**：合并前后数据一致性验证，确保数据准确性和完整性
- **统计分析**：提供详细的数据质量报告和统计信息，帮助用户了解数据状况
- **本地运行**：所有数据处理均在本地完成，保护用户隐私和数据安全

## 技术栈

- **Python 3.8+**：主要开发语言
- **Pandas**：强大的数据处理和分析库
- **OpenPyXL/XlsxWriter**：Excel文件处理和高级格式化
- **Regular Expressions**：文本处理和数据提取
- **Datetime**：日期时间处理和格式化

## 安装说明

### 1. 克隆项目

```bash
git clone https://github.com/antareserQi/bill-merger-tool.git
cd bill-merger-tool
```

### 2. 安装依赖

使用pip安装所需依赖：

```bash
pip install -r requirements.txt
```

## 依赖列表

- pandas>=1.3.0：数据处理和分析
- openpyxl>=3.0.0：Excel文件读取
- xlsxwriter>=3.0.0：Excel文件写入和格式化

## 使用方法

### 1. 准备账单文件

- **微信账单**：
  - 打开微信，进入「我」→「服务」→「钱包」→「客服中心」→「常用工具」→「下载账单」
  - 选择「用于个人对账」，选择账单时间范围
  - 下载得到 `.zip` 文件（如果通过邮箱发送，需要输入解压缩密码解压）
  - 解压后得到 `.xlsx` 文件，将该文件放到程序同一目录下，确保文件名包含「微信」字样以便程序识别

- **支付宝账单**：
  - 打开支付宝，进入「我的」→「账单」→「右上角三个点」→「开局交易流水证明」
  - 选择「用于个人对账」，点击「申请」
  - 下载得到 `.zip` 文件（如果通过邮箱发送，需要输入解压缩密码解压）
  - 解压后得到 `.csv` 文件，将该文件放到程序同一目录下，确保文件名包含「支付宝」字样以便程序识别

### 2. 运行程序

将准备好的账单文件放在与 `merge_bills.py` 相同的目录下，然后运行：

```bash
python merge_bills.py
```

### 3. 选择导出方式

程序运行后，会提示选择导出方式：

```
账单导出方式：
1  按月份分开导出（直接按回车键） / 2  所有月份合并导出（输入'2'后按回车键）

请选择导出方式（直接回车选1 / 输入'2'选2）:
```

- 直接按回车键：选择按月份分开导出
- 输入'2'后按回车键：选择所有月份合并导出

### 4. 查看结果

处理完成后，程序会在当前目录生成Excel格式的账单文件：

- **按月份导出**：生成「2023年01月账单.xlsx」等按月份命名的文件
- **合并导出**：生成「总账单.xlsx」文件，包含所有月份的数据

## 数据处理流程

1. **文件识别**：自动扫描当前目录，识别包含「微信」和「支付宝」字样的账单文件
2. **数据读取**：使用Pandas分别读取微信（.xlsx）和支付宝（.csv）账单数据
3. **数据清洗**：处理缺失值、异常值，进行必要的格式转换和数据验证
4. **字段映射**：将不同平台的字段映射到统一的标准格式，确保数据结构一致
5. **数据合并**：合并微信和支付宝的账单数据，创建统一的数据集
6. **数据标准化**：统一交易状态、日期格式等关键数据项，提高数据质量
7. **收支计算**：根据收/支类型计算收支金额，支出为负值，收入为正值
8. **数据验证**：验证合并前后数据的一致性，包括记录数、金额总和等关键指标
9. **格式应用**：应用Excel专业格式，包括首行冻结、筛选功能、日期和会计专用格式
10. **文件导出**：根据用户选择的导出方式，生成相应的Excel文件

## 账单字段说明

合并后的账单包含以下标准字段（与实际导出的字段保持一致）：

| 字段名 | 说明 | 来源 |
|-------|------|------|
| 交易时间 | 交易发生的具体时间 | 微信/支付宝 |
| 交易类型 | 交易的类型（如转账、支付、收款等） | 微信/支付宝 |
| 交易对方 | 交易的对方名称 | 微信/支付宝 |
| 商品/商品名称 | 交易的商品或服务名称 | 微信（商品）/支付宝（商品名称） |
| 收/支 | 交易类型标识（支出或收入） | 微信/支付宝 |
| 金额 | 交易的实际金额 | 微信/支付宝 |
| 收支金额 | 计算后的收支金额（支出为负值，收入为正值） | 程序计算生成 |
| 支付方式 | 支付平台标识（微信支付或支付宝） | 程序自动添加 |
| 交易状态 | 交易的当前状态（已标准化处理） | 微信/支付宝（标准化后） |

## 配置说明

程序使用可配置的参数来处理不同平台的账单数据。核心配置位于代码顶部的`CONFIG`字典中：

```python
CONFIG = {
    'wechat_columns': ['交易时间', '交易类型', '交易对方', '商品', '收/支', '金额', '支付方式', '当前状态', '交易单号', '商户单号', '备注'],
    'alipay_columns': ['交易时间', '交易类型', '交易对方', '对方账户', '商品名称', '收/支', '金额', '支付方式', '交易状态', '交易订单号', '商家订单号', '备注'],
    'merged_columns': ['交易时间', '交易类型', '交易对方', '商品/商品名称', '收/支', '金额', '收支金额', '支付方式', '交易状态'],
    'hidden_columns': ['交易单号', '商户单号/商家订单号', '备注']
}
```

### 关键配置项说明：

- `wechat_columns`：微信账单的原始字段名列表
- `alipay_columns`：支付宝账单的原始字段名列表
- `merged_columns`：合并后账单的标准字段名列表，这些字段会在Excel中显示
- `hidden_columns`：合并后账单的隐藏字段名列表，这些字段包含在数据中但可根据需要在Excel中隐藏

### 交易状态映射配置：

```python
STATUS_MAPPING = {
    '支付成功': ['支付成功', '交易成功', '已支付', '支付完成'],
    '已退款': ['已退款', '退款成功', '退款完成'],
    '交易失败': ['交易失败', '支付失败', '订单关闭']
}
```

## 数据验证机制

为确保数据的准确性和完整性，程序实现了多层数据验证机制：

1. **字段完整性验证**：检查必需字段是否存在且有效
2. **数据类型验证**：验证日期、金额等关键字段的数据类型是否正确
3. **金额有效性验证**：确保金额字段包含有效数值
4. **合并完整性验证**：
   - 记录数一致性检查：验证合并后的记录数等于各平台记录数之和
   - 金额总和一致性检查：验证合并后的总金额等于各平台总金额之和
   - 收支金额一致性检查：验证合并后的收支金额计算结果准确
   - 来源分布一致性检查：验证各平台记录数在合并后保持一致

## Excel格式特性

生成的Excel文件包含以下专业格式特性：

- **首行冻结**：方便用户在滚动查看大量数据时始终保持列标题可见
- **筛选功能**：为所有列添加筛选功能，便于用户快速筛选和查找数据
- **标准日期格式**：统一的日期时间格式，便于时间序列分析
- **会计专用格式**：金额列使用会计专用格式，包含人民币符号和千位分隔符
- **自动计算公式**：收支金额列使用Excel公式自动计算，确保数据动态更新
- **SUBTOTAL汇总**：添加SUBTOTAL公式计算收支金额总和，支持筛选后的动态汇总

## 项目结构

```
bill-merger-tool/
├── merge_bills.py        # 主程序文件
├── README.md            # 项目说明文档
├── requirements.txt     # 项目依赖列表
└── LICENSE              # 开源许可证文件
```

## 常见问题

### Q: 程序无法识别账单文件
A: 请确保账单文件名包含「微信」或「支付宝」字样，且文件格式正确（微信为.xlsx，支付宝为.csv）。检查文件是否放在程序同一目录下。

### Q: 合并后数据有误
A: 请检查原始账单文件格式是否正确，确保符合平台导出的标准格式。程序会进行数据验证并提示不一致的地方，请根据提示进行检查。

### Q: Excel文件打开时提示格式错误
A: 请确保安装了最新版本的依赖，特别是xlsxwriter库。如果问题持续存在，请尝试重新运行程序。

### Q: 数据验证失败但仍想保存文件
A: 程序提供了灵活的选项，即使数据验证失败，用户仍可以选择继续保存文件，但请仔细检查数据质量。

### Q: 如何获取微信支付和支付宝账单的解压密码？
A: 解压密码会通过以下方式发送：
- **微信支付**：解压密码会发送到微信支付的服务消息中，请在微信中点击「我」→「服务」→「消息」查看
- **支付宝**：解压密码会发送到支付宝的服务消息中，请在支付宝中点击「消息」→「通知」查看

### Q: 如何在电脑上解压缩账单文件？
A: 在Windows电脑上解压缩账单文件的步骤：
1. 找到下载的 `.zip` 文件（通常在「下载」文件夹中）
2. 右键点击该文件，选择「全部解压缩」（Windows 10/11）或「解压到当前文件夹」（使用解压软件如WinRAR或7-Zip）
3. 在弹出的解压窗口中，找到「输入密码」或「密码」字段
4. 打开微信支付或支付宝的服务消息，找到解压密码
5. 将解压密码复制并粘贴到解压窗口的密码字段中
6. 点击「确定」或「解压」按钮开始解压缩
7. 解压缩完成后，找到生成的 `.xlsx`（微信）或 `.csv`（支付宝）文件
8. 将该文件复制到程序所在的同一目录下，无需任何修改

### Q: 如何确保账单合并结果的准确性？
A: 为确保账单合并结果的准确性，建议遵循以下最佳实践：

- **时间段选择**：放置相同时间段的微信和支付宝账单可获得最佳效果。工具支持处理多个不同时间段的账单，包括平台间时间段不一致的情况。
- **避免时间重叠**：请勿在同一批处理中包含时间范围重叠的账单文件（如同时处理包含7-9月和8-10月的账单）。重叠日期的交易会被重复合并，导致合并结果中的记录数和金额统计不准确。
- **定期整理**：建议按自然月或季度定期导出账单并进行合并，避免长时间累积后一次性处理大量重叠数据。
- **验证结果**：合并完成后，建议检查生成的Excel文件中的数据质量报告，确认记录数和金额统计是否符合预期。

## 数据安全

本工具高度重视用户数据安全和隐私保护：

- **本地运行**：所有数据处理均在本地计算机完成，不会上传任何用户数据到云端
- **无数据存储**：程序不会在本地存储用户的账单数据，仅在运行过程中临时处理
- **原始文件保护**：程序仅读取原始账单文件，不会修改或删除任何原始数据
- **用户控制**：用户完全控制数据的导入、处理和导出过程

## 贡献指南

欢迎提交Issue和Pull Request来改进这个项目！

### 开发环境设置

1. Fork本项目到您的GitHub账户
2. 克隆Fork后的项目到本地
3. 创建一个新的特性分支
   ```bash
   git checkout -b feature/YourFeature
   ```
4. 安装开发依赖
   ```bash
   pip install -r requirements.txt
   ```
5. 进行开发和测试
6. 提交更改
   ```bash
   git commit -m 'Add: Your feature description'
   ```
7. 推送到您的GitHub分支
   ```bash
   git push origin feature/YourFeature
   ```
8. 打开Pull Request

### 代码规范

- 遵循PEP 8代码规范
- 添加适当的注释，特别是复杂的业务逻辑
- 保持函数和方法的单一职责原则
- 添加必要的错误处理和异常捕获

## 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情

## 联系方式

如有问题或建议，请通过以下方式联系：

- 提交 [Issue](https://github.com/antareserQi/bill-merger-tool/issues)
- 通过GitHub发起讨论

## 更新日志

### v1.0.0 (2025-12-02)
- 初始版本发布
- 支持微信和支付宝账单合并功能
- 实现按月份导出或合并导出功能
- 添加数据验证和质量控制机制
- 支持Excel专业格式化功能
- 提供完整的数据处理流程和用户界面

---

**感谢使用账单合并工具！**
